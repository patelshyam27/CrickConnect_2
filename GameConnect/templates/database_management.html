{% extends "base.html" %}

{% block title %}Database Management - CrickConnect{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-database me-2"></i>Database Management</h2>
                <a href="{{ url_for('owner_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <!-- Database Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5>Total Tables</h5>
                            <h2>{{ total_tables }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-table"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5>Total Records</h5>
                            <h2>{{ total_records }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-list"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5>Database Size</h5>
                            <h2>{{ db_size }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-hdd"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5>Last Backup</h5>
                            <h2>{{ last_backup }}</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-save"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Database Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-tools me-2"></i>Database Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('backup_database') }}" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-download me-2"></i>Backup Database
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('optimize_database') }}" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-bolt me-2"></i>Optimize Database
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button type="button" class="btn btn-danger btn-lg w-100" data-bs-toggle="modal" data-bs-target="#resetModal">
                                <i class="fas fa-trash-alt me-2"></i>Reset Database
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button type="button" class="btn btn-info btn-lg w-100" data-bs-toggle="modal" data-bs-target="#restoreModal">
                                <i class="fas fa-upload me-2"></i>Restore Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Database Tables -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-table me-2"></i>Database Tables</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Table Name</th>
                                    <th>Records</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in tables %}
                                <tr>
                                    <td>{{ table.name }}</td>
                                    <td>{{ table.records }}</td>
                                    <td>{{ table.size }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('view_table', table_name=table.name) }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('export_table', table_name=table.name) }}" class="btn btn-sm btn-success">
                                                <i class="fas fa-file-export"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#truncateModal{{ table.name }}">
                                                <i class="fas fa-eraser"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Database Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resetModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Reset Database</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <p><strong>Warning:</strong> This action will delete ALL data in the database. This cannot be undone unless you have a backup.</p>
                    <p>Please type "RESET" in the field below to confirm:</p>
                </div>
                <form action="{{ url_for('reset_database') }}" method="POST" id="resetForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="confirmation" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reset Database</button>
                    </div>
                </form>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Restore Backup Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="restoreModalLabel"><i class="fas fa-upload me-2"></i>Restore Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <p><strong>Warning:</strong> Restoring a backup will overwrite the current database. Make sure to backup your current data first.</p>
                </div>
                <form action="{{ url_for('restore_database') }}" method="POST" enctype="multipart/form-data" id="restoreForm">
                    <div class="mb-3">
                        <label for="backupFile" class="form-label">Select Backup File</label>
                        <input type="file" class="form-control" id="backupFile" name="backup_file" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-info">Restore Backup</button>
                    </div>
                </form>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Truncate Table Modals -->
{% for table in tables %}
<div class="modal fade" id="truncateModal{{ table.name }}" tabindex="-1" aria-labelledby="truncateModal{{ table.name }}Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="truncateModal{{ table.name }}Label"><i class="fas fa-exclamation-triangle me-2"></i>Truncate {{ table.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <p><strong>Warning:</strong> This action will delete ALL data in the {{ table.name }} table. This cannot be undone.</p>
                    <p>Are you sure you want to proceed?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{{ url_for('truncate_table', table_name=table.name) }}" class="btn btn-danger">Truncate Table</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}